- name: Start the Docker containers
  local_action:
    module: docker
    name: "{{ item['name'] }}"
    image: "{{ item['image'] }}"
    privileged: true
    state: reloaded
    use_tls: encrypt
    ports:
      - "{{ item['ssh_port'] }}:22"
    volumes:
      - "/sys/fs/cgroup:/sys/fs/cgroup"
  with_items: "{{ docker_containers }}"

- name: Give the containers time to start sshd
  pause: seconds=5

- name: Verify sshd has started
  wait_for:
    host: "{{ ansible_host }}"
    port: "{{ item['ssh_port'] }}"
    timeout: 30
  with_items: "{{ docker_containers }}"
